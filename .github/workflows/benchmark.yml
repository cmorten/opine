name: Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  benchmark:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        deno-version: [1.0.2]

    steps:
      - name: Install wrk package
        run: |
          curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install build-essential libssl-dev git -y
          git clone https://github.com/wg/wrk.git wrk
          cd wrk
          make
          # move the executable to somewhere in your PATH, ex:
          sudo cp wrk /usr/local/bin
      - uses: actions/checkout@v2
      - name: Use Deno ${{ matrix.deno-version }}
        uses: denolib/setup-deno@master
        with:
          deno-version: ${{ matrix.deno-version }}
      - name: Run Benchmark Tests
        run: echo "::set-output name=results::$(make benchmark)"
        id: run_benchmark_tests
      - name: Add Comment To PR
        env:
          BODY: ${{ steps.run_benchmark_tests.outputs.results }}
          URL: ${{ github.event.issue.comments_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl \
            -X POST \
            ${URL} \
            -H "Content-Type: application/json" \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            --data "{ \"body\": \"${BODY}\" }"
